%!TeX encoding = UTF-8
%!TeX root = ../main.tex
\chapter{Software specifications}
\label{chapter:softwarereqs}

\section{Bootstrap module}

The bootstrap module must initialize Docker, Docker-compose and must update our program to the latest
version (by downloading from the internet).

As we have absolutely no guarantee that anyone could see anything (neither on the \gls{plc} nor computer screen),
we must echo BEEPs in order to signal a problem.

Hence, a few seconds/minutes after PC boot, one should hear a signal indicating if everything went along.
The signal is the following:

\begin{table}[ht]
	\centering
	% {\scalefont{0.9}
	\begin{tabular}{@{}ll@{}}
	\toprule
        Number of beeps &   Meaning \\ \midrule
        0               &   No initialization: bootstrap didn't run at all. \\
        1               &   Bootstrap ok, update ok, containers up and running. \\
        2               &   No internet. Containers are up and running but out-to-date. \\ \bottomrule
	\end{tabular}
	% }
	\caption{Meaning of startup beeps.}
	\label{table:beeps}
\end{table}

Here's a way to send beeps from the shell:

\begin{lstlisting}[style=Bash,caption={beep}]
echo -ne '\007 \007'
\end{lstlisting}

\section{Main loop}

(explained elsewhere)

\section{Barcode reader}

The barcode reader function must:

\begin{enumerate}
    \item Open the camera
    \item Check that the \gls{plc} command is still "barcode reading", if not skip next step
    \item Read a barcode if present (if not present, return to previous step)
    \item Close the camera
    \item Transmit the barcode value and/or status to the \gls{plc} if we have it
\end{enumerate}

\importantbox{If no barcode can be read, it's up to the \gls{plc} to decide to cut the connexion
by using the command value}

\importantbox{When returning to the PLC, the output value must be ASCII characters (ie. starting from 64)}

EAN length in the \gls{plc} is 32~characters.

\section{Bootstrap module}

\subsection{Dependencies}

The OS is Linux (headless), Debian or Ubuntu.

\todo{Specify OS needs here}

We also need:

\begin{itemize}
    \item Docker, >= 18.0.9
    \item Docker-compose, >= 1.23.2
\end{itemize}


\section{Container: \texttt{ecoclassifier-main}}

\subsection{Container role}

This is the container holding the main camera program.

It has the main loop.

\subsection{Dependencies}

\notebox{If we have performance issues and/or problems to keep up with the \gls{heartbeat},
we could add another container to handle the heartbeat specifically.}

Here's the list of software that must be configured on the container:

\begin{itemize}
    \item Python >= 3.6
    \item OpenCV
    \item Snap7 software (for \gls{plc} communication)
    \item Basler software (bundled with our Dockerfile!)
    \item Semi-async mode (main loop for image capture, async mode for the upload part)
    \item Keras
    \item Usual requirements.txt additional packages
\end{itemize}

Plus we have to enable the following service/packages/libraries:

\begin{itemize}
    \item \texttt{Sentry} (see \url{https://sentry.io}) to report exceptions
    \item \texttt{timeout-decorator} (see \url{https://github.com/pnpnpn/timeout-decorator})
    \item \texttt{Tenacity} (see \url{https://github.com/jd/tenacity})
\end{itemize}


\subsection{Main loop}

Main loop's purpose is to open necessary connexions, listen to the \gls{plc} and decide what to do depending on what's available here.

Here's the list of tasks this section must provide:

\begin{enumerate}
    \item Handle the \gls{heartbeat} (see \ref{section:heartbeat})
    \item Check if a barcode scan has to be performed (see \ref{section:barcode})
    \item Check if a plastic recognition task has to be performed (see \ref{section:classifier})
    \item Wait for a little while and go back to step 1
\end{enumerate}




\section{Container: \texttt{ecoclassifier-sync}}

\subsection{Container role}

This is the container that syncs acquired images to our Azure BLOB.

\subsection{Dependencies}

\begin{itemize}
    \item Azure Command-Line Interface
\end{itemize}
